<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link href="/src/output.css" rel="stylesheet" />
  </head>

  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <!-- Page Title -->
      <h1 class="text-3xl font-semibold text-gray-800 mb-10">User Dashboard</h1>

      <!-- ============================= -->
      <!-- Donation History Section -->
      <!-- ============================= -->

      <section class="mb-14">
        <h2 class="text-xl font-semibold text-gray-700 mb-6">
          Your Donation History
        </h2>

        <div
          id="donationContainer"
          class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden"
        ></div>
      </section>

      <!-- ============================= -->
      <!-- Charities Section -->
      <!-- ============================= -->

      <section>
        <h2 class="text-xl font-semibold text-gray-700 mb-6">
          Explore Charities
        </h2>

        <div
          id="charityContainer"
          class="grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
        ></div>

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-6 mt-10">
          <button
            id="prevBtn"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm"
          >
            Prev
          </button>

          <span id="pageInfo" class="text-sm text-gray-600 font-medium"> </span>

          <button
            id="nextBtn"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm"
          >
            Next
          </button>
        </div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "login.html";
      }

      // Decode JWT
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join(""),
          );

          return JSON.parse(jsonPayload);
        } catch (err) {
          return null;
        }
      }

      const decoded = parseJwt(token);

      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // Check Expiry
      if (decoded.exp * 1000 < Date.now()) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // Check Role
      if (decoded.role !== "USER") {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // ==============================
      // Donation History
      // ==============================

      async function fetchDonations() {
        try {
          const res = await axios.get("/api/donations/my", {
            headers: { Authorization: token },
          });

          const container = document.getElementById("donationContainer");

          if (!res.data.length) {
            container.innerHTML = `
            <div class="p-6 text-gray-500 text-sm">
              No donations yet.
            </div>`;
            return;
          }

          container.innerHTML = res.data
            .map(
              (d) => `
          <div class="flex justify-between items-center p-4 border-b last:border-b-0">
            <div>
              <p class="font-medium text-gray-800">${d.charity_name}</p>
              <p class="text-sm text-gray-500">${new Date(d.created_at).toLocaleDateString()}</p>
            </div>
            <span class="font-semibold text-indigo-600">
              â‚¹${d.amount}
            </span>
          </div>
        `,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      // ==============================
      // Charity Pagination
      // ==============================

      let currentPage = 1;
      let totalPages = 1;

      async function fetchCharities(page = 1) {
        try {
          const res = await axios.get(`/api/charities?page=${page}`, {
            headers: { Authorization: token },
          });

          const { charities, totalPages: tp, currentPage: cp } = res.data;

          totalPages = tp;
          currentPage = cp;

          console.log(charities);

          renderCharities(charities);
          updatePagination();
        } catch (err) {
          console.error(err);
        }
      }
      function renderCharities(data) {
        const container = document.getElementById("charityContainer");

        container.innerHTML = data
          .map(
            (c) => `
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 flex flex-col justify-between">

          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">
              ${c.name}
            </h3>

            <p class="text-sm text-gray-600 mb-4 line-clamp-3">
              ${c.description || "No description available"}
            </p>
          </div>

          <button
            class="mt-4 bg-indigo-600 text-white text-sm py-2 rounded-xl hover:bg-indigo-700 transition">
            Donate
          </button>

        </div>
      `,
          )
          .join("");
      }

      function updatePagination() {
        document.getElementById("pageInfo").innerText =
          `Page ${currentPage} of ${totalPages}`;

        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        prevBtn.classList.toggle("cursor-not-allowed", prevBtn.disabled);

        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
        nextBtn.classList.toggle("cursor-not-allowed", nextBtn.disabled);
      }

      // ==============================
      // Pagination Buttons
      // ==============================

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          fetchCharities(currentPage - 1);
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          fetchCharities(currentPage + 1);
        }
      });

      // ==============================
      // Initial Load
      // ==============================

      fetchDonations();
      fetchCharities(currentPage);
    </script>
  </body>
</html>
