<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link href="/src/output.css" rel="stylesheet" />
  </head>

  <body class="bg-gray-50 min-h-screen">
    <!-- Welcome Section -->
    <div
      class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-6"
    >
      <!-- Left Side -->
      <div>
        <h2 class="text-2xl font-semibold text-gray-800">
          Welcome back,
          <span id="userName" class="text-indigo-600">User</span> ðŸ‘‹
        </h2>
        <p class="text-gray-500 text-sm mt-1">
          Here's an overview of your activity and available charities.
        </p>
      </div>

      <!-- Right Side -->
      <div class="flex items-center gap-4">
        <!-- Optional Role Badge -->
        <span
          class="px-3 py-1 text-xs font-medium bg-indigo-100 text-indigo-600 rounded-full"
        >
          DONOR
        </span>

        <!-- Logout Button -->
        <button
          onclick="logout()"
          class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 rounded-xl transition"
        >
          Logout
        </button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 py-10">
      <!-- Page Title -->
      <h1 class="text-3xl font-semibold text-gray-800 mb-10">User Dashboard</h1>

      <!-- ============================= -->
      <!-- Donation History Section -->
      <!-- ============================= -->

      <section class="mb-14">
        <h2 class="text-xl font-semibold text-gray-700 mb-6">
          Your Donation History
        </h2>

        <div
          id="donationContainer"
          class="bg-white rounded-xl shadow p-4 max-h-[70vh] overflow-y-auto"
        ></div>
      </section>

      <!-- ============================= -->
      <!-- Charities Section -->
      <!-- ============================= -->

      <section>
        <h2 class="text-xl font-semibold text-gray-700 mb-6">
          Explore Charities
        </h2>

        <div
          id="charityContainer"
          class="grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
        ></div>

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-6 mt-10">
          <button
            id="prevBtn"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm"
          >
            Prev
          </button>

          <span id="pageInfo" class="text-sm text-gray-600 font-medium"> </span>

          <button
            id="nextBtn"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition text-sm"
          >
            Next
          </button>
        </div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "login.html";
      }
      function logout() {
        localStorage.clear();
        window.location.href = "login.html";
      }

      // Decode JWT
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join(""),
          );

          return JSON.parse(jsonPayload);
        } catch (err) {
          return null;
        }
      }

      const decoded = parseJwt(token);

      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // Check Expiry
      if (decoded.exp * 1000 < Date.now()) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // Check Role
      if (decoded.role !== "USER") {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }
      console.log(decoded);
      if (decoded?.name) {
        document.getElementById("userName").innerText = decoded.name;
      }

      // ==============================
      // Donation History
      // ==============================

      async function fetchDonations() {
        try {
          const res = await axios.get("/api/donations/my", {
            headers: { Authorization: token },
          });

          const container = document.getElementById("donationContainer");

          const donations = res.data.donations;

          if (!donations.length) {
            container.innerHTML = `
    <div class="p-6 text-gray-500 text-sm">
      No donations yet.
    </div>`;
            return;
          }

          container.innerHTML = donations
            .map(
              (d) => `
  <div class="bg-green-50 border border-green-200 rounded-xl p-5 mb-4 shadow-sm hover:shadow-md transition duration-300">
    
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-green-800">
        ${d.charity.name}
      </h3>
      <span class="bg-green-100 text-green-700 text-xs font-medium px-3 py-1 rounded-full">
        Successful
      </span>
    </div>

    <div class="mt-1 flex justify-between items-center">
      <p class="text-sm text-gray-600">
        Amount Donated
      </p>
      <p class="text-xl font-bold text-green-700">
        â‚¹${d.amount}
      </p>
    </div>

    <p class="text-xs text-gray-400 mt-1">
      ${new Date(d.createdAt).toLocaleDateString()}
    </p>

  </div>
  
`,
            )
            .join("");
        } catch (err) {
          console.error(err);
        }
      }

      // ==============================
      // Charity Pagination
      // ==============================

      let currentPage = 1;
      let totalPages = 1;

      async function fetchCharities(page = 1) {
        try {
          const res = await axios.get(`/api/charities?page=${page}`, {
            headers: { Authorization: token },
          });

          const { charities, totalPages: tp, currentPage: cp } = res.data;

          totalPages = tp;
          currentPage = cp;

          console.log(charities);

          renderCharities(charities);
          updatePagination();
        } catch (err) {
          console.error(err);
        }
      }
      function renderCharities(data) {
        const container = document.getElementById("charityContainer");

        data.forEach((c) => {
          const collected = c.collected_amount ? c.collected_amount : 0;
          const goal = c.goal_amount ? c.goal_amount : 1;

          const percentage = Math.min(
            Math.round((collected / goal) * 100),
            100,
          );
        

          container.innerHTML += `
    <div class="bg-white shadow-md rounded-xl p-6 hover:shadow-lg transition flex flex-col justify-between">

      <div>
        <h4 class="text-lg font-semibold mb-2">${c.name}</h4>

        <p class="text-gray-600 text-sm mb-4">
          ${c.description || "No description available."}
        </p>

        <div class="mb-2 flex justify-between text-sm">
          <span class="font-medium text-gray-700">
            â‚¹${collected} raised
          </span>
          <span class="text-gray-500">
            Goal â‚¹${goal}
          </span>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div 
            class="bg-indigo-600 h-3 rounded-full transition-all duration-500"
            style="width: ${percentage}%">
          </div>
        </div>

        <div class="mt-2 text-right text-xs text-gray-500">
          ${percentage}% funded
        </div>
      </div>

      <!-- Donate Button -->
      <button 
        onclick="redirectToLogin()" 
        class="mt-6 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition w-fit">
        Donate Now
      </button>

    </div>
  `;
        });
      }

      function updatePagination() {
        document.getElementById("pageInfo").innerText =
          `Page ${currentPage} of ${totalPages}`;

        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        prevBtn.classList.toggle("cursor-not-allowed", prevBtn.disabled);

        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
        nextBtn.classList.toggle("cursor-not-allowed", nextBtn.disabled);
      }

      // ==============================
      // Pagination Buttons
      // ==============================

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          fetchCharities(currentPage - 1);
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          fetchCharities(currentPage + 1);
        }
      });

      // ==============================
      // Initial Load
      // ==============================

      fetchDonations();
      fetchCharities(currentPage);
      async function startDonation(charityId) {
        try {
          const amount = prompt("Enter donation amount (in â‚¹):");

          if (!amount || amount <= 0) {
            alert("Invalid amount");
            return;
          }

          // 1ï¸âƒ£ Create order from backend
          const res = await axios.post(
            "/api/donations/createOrder",
            { amount, charityId },
            { headers: { Authorization: token } },
          );

          const { orderId, amount: amountRzr, currency } = res.data;

          // 2ï¸âƒ£ Open Razorpay Checkout
          const options = {
            key: "rzp_test_SKj5s63xp7kI7e", // Public key only
            amount: amountRzr,
            currency: currency,
            name: "Charity Donation",
            description: "Donation Payment",
            order_id: orderId,

            handler: async function (response) {
              // 3ï¸âƒ£ Send payment details to backend for verification
              await axios.post(
                "/api/donations/verifyPayment",
                {
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_signature: response.razorpay_signature,
                  charityId,
                  amount,
                },
                { headers: { Authorization: token } },
              );

              alert("Payment Successful ðŸŽ‰");
              fetchDonations(); // refresh donation history
            },

            theme: {
              color: "#4F46E5",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (err) {
          console.error(err);
          alert("Payment failed");
        }
      }
    </script>
  </body>
</html>
